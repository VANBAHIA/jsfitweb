# Guia: Implementar V√≠nculo Exerc√≠cio-Equipamento (Many-to-Many)

## üìã Vis√£o Geral
Implementaremos um relacionamento **muitos-para-muitos** entre Exerc√≠cios e Equipamentos, permitindo:
- ‚úÖ Um exerc√≠cio em v√°rios equipamentos
- ‚úÖ Um equipamento com v√°rios exerc√≠cios
- ‚úÖ Manter hist√≥rico de disponibilidade

---

## üóÑÔ∏è 1. Atualizar Schema Prisma

### Arquivo: `prisma/schema.prisma`

```prisma
// Modelo de jun√ß√£o (tabela de relacionamento)
model ExercicioEquipamento {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  exercicioId String      @db.ObjectId
  exercicio   Exercicio   @relation("ExercicioEquipamentos", fields: [exercicioId], references: [id], onDelete: Cascade)
  equipamentoId String    @db.ObjectId
  equipamento Equipamento @relation("EquipamentoExercicios", fields: [equipamentoId], references: [id], onDelete: Cascade)
  
  // Metadados opcionais
  descricaoUso String?    // Ex: "Usar com cuidado - ajustar altura"
  disponivel   Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // √çndices para performance
  @@unique([exercicioId, equipamentoId]) // Evita duplicatas
  @@index([exercicioId])
  @@index([equipamentoId])
  @@map("exercicio_equipamentos")
}

// Atualizar modelo Exercicio
model Exercicio {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  nome       String
  descricao  String?
  musculos   String[]
  empresaId  String   @db.ObjectId
  empresa    Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  grupoId    String?  @db.ObjectId
  grupo      GrupoExercicio? @relation(fields: [grupoId], references: [id], onDelete: SetNull)
  imagemUrl  String?
  
  // ‚úÖ NOVO: Relacionamento com equipamentos
  equipamentos ExercicioEquipamento[] @relation("ExercicioEquipamentos")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([empresaId])
  @@index([grupoId])
  @@map("exercicios")
}

// Atualizar modelo Equipamento
model Equipamento {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  codigo    String
  nome      String
  empresaId String   @db.ObjectId
  empresa   Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  
  // ‚úÖ NOVO: Relacionamento com exerc√≠cios
  exercicios ExercicioEquipamento[] @relation("EquipamentoExercicios")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([codigo, empresaId])
  @@index([empresaId])
  @@index([codigo])
  @@map("equipamentos")
}
```

### Executar migra√ß√£o:
```bash
npx prisma migrate dev --name add_exercicio_equipamento_relation
```

---

## üìÅ 2. Criar Repository

### Arquivo: `src/repositories/exercicioEquipamentoRepository.js`

```javascript
const prisma = require('../config/database');

class ExercicioEquipamentoRepository {
  // Vincular exerc√≠cio a equipamento
  async vincular(exercicioId, equipamentoId, descricaoUso = null) {
    return await prisma.exercicioEquipamento.create({
      data: {
        exercicioId,
        equipamentoId,
        descricaoUso,
        disponivel: true
      }
    });
  }

  // Buscar v√≠nculo existente
  async buscarVinculo(exercicioId, equipamentoId) {
    return await prisma.exercicioEquipamento.findUnique({
      where: {
        exercicioId_equipamentoId: {
          exercicioId,
          equipamentoId
        }
      }
    });
  }

  // Listar todos os equipamentos de um exerc√≠cio
  async buscarEquipamentosPorExercicio(exercicioId, empresaId) {
    return await prisma.exercicioEquipamento.findMany({
      where: {
        exercicioId,
        equipamento: { empresaId } // Validar empresa
      },
      include: {
        equipamento: {
          select: {
            id: true,
            codigo: true,
            nome: true
          }
        }
      }
    });
  }

  // Listar todos os exerc√≠cios de um equipamento
  async buscarExerciciosPorEquipamento(equipamentoId, empresaId) {
    return await prisma.exercicioEquipamento.findMany({
      where: {
        equipamentoId,
        exercicio: { empresaId } // Validar empresa
      },
      include: {
        exercicio: {
          select: {
            id: true,
            nome: true,
            musculos: true,
            imagemUrl: true
          }
        }
      }
    });
  }

  // Desvincular exerc√≠cio de equipamento
  async desvincular(exercicioId, equipamentoId) {
    return await prisma.exercicioEquipamento.delete({
      where: {
        exercicioId_equipamentoId: {
          exercicioId,
          equipamentoId
        }
      }
    });
  }

  // Atualizar metadados do v√≠nculo
  async atualizar(exercicioId, equipamentoId, dados) {
    return await prisma.exercicioEquipamento.update({
      where: {
        exercicioId_equipamentoId: {
          exercicioId,
          equipamentoId
        }
      },
      data: dados
    });
  }

  // Contar quantos equipamentos um exerc√≠cio usa
  async contarEquipamentos(exercicioId) {
    return await prisma.exercicioEquipamento.count({
      where: { exercicioId }
    });
  }

  // Contar quantos exerc√≠cios um equipamento tem
  async contarExercicios(equipamentoId) {
    return await prisma.exercicioEquipamento.count({
      where: { equipamentoId }
    });
  }

  // Deletar todos os v√≠nculos de um exerc√≠cio (quando deletar exerc√≠cio)
  async deletarPorExercicio(exercicioId) {
    return await prisma.exercicioEquipamento.deleteMany({
      where: { exercicioId }
    });
  }

  // Deletar todos os v√≠nculos de um equipamento (quando deletar equipamento)
  async deletarPorEquipamento(equipamentoId) {
    return await prisma.exercicioEquipamento.deleteMany({
      where: { equipamentoId }
    });
  }
}

module.exports = new ExercicioEquipamentoRepository();
```

---

## üîß 3. Criar Service

### Arquivo: `src/services/exercicioEquipamentoService.js`

```javascript
const exercicioEquipamentoRepository = require('../repositories/exercicioEquipamentoRepository');
const exercicioRepository = require('../repositories/exercicioRepository');
const equipamentoRepository = require('../repositories/equipamentoRepository');
const ApiError = require('../utils/apiError');

class ExercicioEquipamentoService {
  /**
   * Vincular um exerc√≠cio a um equipamento
   */
  async vincularExercicioEquipamento(exercicioId, equipamentoId, empresaId, descricaoUso = null) {
    // 1. Validar se exerc√≠cio existe e pertence √† empresa
    const exercicio = await exercicioRepository.buscarPorId(exercicioId, empresaId);
    if (!exercicio) {
      throw new ApiError(404, 'Exerc√≠cio n√£o encontrado nesta empresa');
    }

    // 2. Validar se equipamento existe e pertence √† empresa
    const equipamento = await equipamentoRepository.buscarPorId(equipamentoId, empresaId);
    if (!equipamento) {
      throw new ApiError(404, 'Equipamento n√£o encontrado nesta empresa');
    }

    // 3. Verificar se j√° existe v√≠nculo
    const vinculoExistente = await exercicioEquipamentoRepository.buscarVinculo(
      exercicioId,
      equipamentoId
    );
    if (vinculoExistente) {
      throw new ApiError(400, 'Este exerc√≠cio j√° est√° vinculado a este equipamento');
    }

    // 4. Criar v√≠nculo
    return await exercicioEquipamentoRepository.vincular(
      exercicioId,
      equipamentoId,
      descricaoUso
    );
  }

  /**
   * Listar equipamentos de um exerc√≠cio com suas informa√ß√µes completas
   */
  async obterEquipamentosDoExercicio(exercicioId, empresaId) {
    const exercicio = await exercicioRepository.buscarPorId(exercicioId, empresaId);
    if (!exercicio) {
      throw new ApiError(404, 'Exerc√≠cio n√£o encontrado');
    }

    return await exercicioEquipamentoRepository.buscarEquipamentosPorExercicio(
      exercicioId,
      empresaId
    );
  }

  /**
   * Listar exerc√≠cios de um equipamento
   */
  async obterExerciciosDoEquipamento(equipamentoId, empresaId) {
    const equipamento = await equipamentoRepository.buscarPorId(equipamentoId, empresaId);
    if (!equipamento) {
      throw new ApiError(404, 'Equipamento n√£o encontrado');
    }

    return await exercicioEquipamentoRepository.buscarExerciciosPorEquipamento(
      equipamentoId,
      empresaId
    );
  }

  /**
   * Desvincular exerc√≠cio de equipamento
   */
  async desvincularExercicioEquipamento(exercicioId, equipamentoId, empresaId) {
    // Validar que ambos existem
    const exercicio = await exercicioRepository.buscarPorId(exercicioId, empresaId);
    if (!exercicio) throw new ApiError(404, 'Exerc√≠cio n√£o encontrado');

    const equipamento = await equipamentoRepository.buscarPorId(equipamentoId, empresaId);
    if (!equipamento) throw new ApiError(404, 'Equipamento n√£o encontrado');

    // Verificar se v√≠nculo existe
    const vinculo = await exercicioEquipamentoRepository.buscarVinculo(
      exercicioId,
      equipamentoId
    );
    if (!vinculo) {
      throw new ApiError(404, 'V√≠nculo n√£o encontrado');
    }

    return await exercicioEquipamentoRepository.desvincular(exercicioId, equipamentoId);
  }

  /**
   * Atualizar metadados do v√≠nculo (ex: descri√ß√£o de uso, disponibilidade)
   */
  async atualizarVinculo(exercicioId, equipamentoId, empresaId, dados) {
    const exercicio = await exercicioRepository.buscarPorId(exercicioId, empresaId);
    if (!exercicio) throw new ApiError(404, 'Exerc√≠cio n√£o encontrado');

    const equipamento = await equipamentoRepository.buscarPorId(equipamentoId, empresaId);
    if (!equipamento) throw new ApiError(404, 'Equipamento n√£o encontrado');

    const vinculo = await exercicioEquipamentoRepository.buscarVinculo(
      exercicioId,
      equipamentoId
    );
    if (!vinculo) {
      throw new ApiError(404, 'V√≠nculo n√£o encontrado');
    }

    return await exercicioEquipamentoRepository.atualizar(exercicioId, equipamentoId, dados);
  }

  /**
   * Buscar informa√ß√µes completas do exerc√≠cio com seus equipamentos
   */
  async obterExercicioComEquipamentos(exercicioId, empresaId) {
    const exercicio = await exercicioRepository.buscarPorId(exercicioId, empresaId);
    if (!exercicio) {
      throw new ApiError(404, 'Exerc√≠cio n√£o encontrado');
    }

    const equipamentos = await exercicioEquipamentoRepository.buscarEquipamentosPorExercicio(
      exercicioId,
      empresaId
    );

    return {
      exercicio,
      equipamentos: equipamentos.map(e => ({
        id: e.equipamento.id,
        codigo: e.equipamento.codigo,
        nome: e.equipamento.nome,
        descricaoUso: e.descricaoUso,
        disponivel: e.disponivel,
        vinculoId: e.id
      }))
    };
  }
}

module.exports = new ExercicioEquipamentoService();
```

---

## üõ£Ô∏è 4. Criar Rotas

### Arquivo: `src/routes/exercicioEquipamentoRoutes.js`

```javascript
const express = require('express');
const router = express.Router();
const exercicioEquipamentoController = require('../controllers/exercicioEquipamentoController');
const { verificarAutenticacao } = require('../middlewares/auth');
const { setEmpresaContext } = require('../middlewares/empresaContext');

/**
 * @route   POST /api/exercicios/:exercicioId/equipamentos/:equipamentoId
 * @desc    Vincular exerc√≠cio a equipamento
 */
router.post(
  '/:exercicioId/equipamentos/:equipamentoId',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.vincular
);

/**
 * @route   GET /api/exercicios/:exercicioId/equipamentos
 * @desc    Listar equipamentos de um exerc√≠cio
 */
router.get(
  '/:exercicioId/equipamentos',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.listarEquipamentosDoExercicio
);

/**
 * @route   GET /api/exercicios/:exercicioId/completo
 * @desc    Obter exerc√≠cio com todos seus equipamentos
 */
router.get(
  '/:exercicioId/completo',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.obterExercicioCompleto
);

/**
 * @route   DELETE /api/exercicios/:exercicioId/equipamentos/:equipamentoId
 * @desc    Desvincular exerc√≠cio de equipamento
 */
router.delete(
  '/:exercicioId/equipamentos/:equipamentoId',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.desvincular
);

/**
 * @route   PATCH /api/exercicios/:exercicioId/equipamentos/:equipamentoId
 * @desc    Atualizar v√≠nculo (descri√ß√£o, disponibilidade)
 */
router.patch(
  '/:exercicioId/equipamentos/:equipamentoId',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.atualizarVinculo
);

/**
 * ROTAS INVERSAS - Por Equipamento
 */

/**
 * @route   GET /api/equipamentos/:equipamentoId/exercicios
 * @desc    Listar exerc√≠cios de um equipamento
 */
router.get(
  '/equipamentos/:equipamentoId/exercicios',
  verificarAutenticacao,
  setEmpresaContext,
  exercicioEquipamentoController.listarExerciciosDoEquipamento
);

module.exports = router;
```

---

## üéÆ 5. Criar Controller

### Arquivo: `src/controllers/exercicioEquipamentoController.js`

```javascript
const exercicioEquipamentoService = require('../services/exercicioEquipamentoService');
const asyncHandler = require('../utils/asyncHandler');
const ApiResponse = require('../utils/apiResponse');
const ApiError = require('../utils/apiError');

class ExercicioEquipamentoController {
  /**
   * Vincular exerc√≠cio a equipamento
   */
  vincular = asyncHandler(async (req, res) => {
    const { exercicioId, equipamentoId } = req.params;
    const { descricaoUso } = req.body;
    const empresaId = req.empresaId;

    const resultado = await exercicioEquipamentoService.vincularExercicioEquipamento(
      exercicioId,
      equipamentoId,
      empresaId,
      descricaoUso
    );

    res.status(201).json(
      new ApiResponse(201, resultado, 'Exerc√≠cio vinculado ao equipamento com sucesso')
    );
  });

  /**
   * Listar equipamentos de um exerc√≠cio
   */
  listarEquipamentosDoExercicio = asyncHandler(async (req, res) => {
    const { exercicioId } = req.params;
    const empresaId = req.empresaId;

    const equipamentos = await exercicioEquipamentoService.obterEquipamentosDoExercicio(
      exercicioId,
      empresaId
    );

    res.status(200).json(
      new ApiResponse(200, equipamentos, 'Equipamentos do exerc√≠cio listados com sucesso')
    );
  });

  /**
   * Obter exerc√≠cio completo com equipamentos
   */
  obterExercicioCompleto = asyncHandler(async (req, res) => {
    const { exercicioId } = req.params;
    const empresaId = req.empresaId;

    const resultado = await exercicioEquipamentoService.obterExercicioComEquipamentos(
      exercicioId,
      empresaId
    );

    res.status(200).json(
      new ApiResponse(200, resultado, 'Exerc√≠cio com equipamentos obtido com sucesso')
    );
  });

  /**
   * Listar exerc√≠cios de um equipamento
   */
  listarExerciciosDoEquipamento = asyncHandler(async (req, res) => {
    const { equipamentoId } = req.params;
    const empresaId = req.empresaId;

    const exercicios = await exercicioEquipamentoService.obterExerciciosDoEquipamento(
      equipamentoId,
      empresaId
    );

    res.status(200).json(
      new ApiResponse(200, exercicios, 'Exerc√≠cios do equipamento listados com sucesso')
    );
  });

  /**
   * Desvincular exerc√≠cio de equipamento
   */
  desvincular = asyncHandler(async (req, res) => {
    const { exercicioId, equipamentoId } = req.params;
    const empresaId = req.empresaId;

    await exercicioEquipamentoService.desvincularExercicioEquipamento(
      exercicioId,
      equipamentoId,
      empresaId
    );

    res.status(200).json(
      new ApiResponse(200, null, 'Exerc√≠cio desvinculado do equipamento com sucesso')
    );
  });

  /**
   * Atualizar v√≠nculo
   */
  atualizarVinculo = asyncHandler(async (req, res) => {
    const { exercicioId, equipamentoId } = req.params;
    const { descricaoUso, disponivel } = req.body;
    const empresaId = req.empresaId;

    const dados = {};
    if (descricaoUso !== undefined) dados.descricaoUso = descricaoUso;
    if (disponivel !== undefined) dados.disponivel = disponivel;

    const resultado = await exercicioEquipamentoService.atualizarVinculo(
      exercicioId,
      equipamentoId,
      empresaId,
      dados
    );

    res.status(200).json(
      new ApiResponse(200, resultado, 'V√≠nculo atualizado com sucesso')
    );
  });
}

module.exports = new ExercicioEquipamentoController();
```

---

## üìù 6. Registrar Rotas no Index

### Arquivo: `src/routes/index.js`

```javascript
// ... imports existentes ...
const exercicioEquipamentoRoutes = require('./exercicioEquipamentoRoutes');

// ... outros routes ...

// Registrar rotas de exerc√≠cio-equipamento
router.use('/exercicios', exercicioEquipamentoRoutes);

// ... resto do arquivo ...
```

---

## üìö 7. Exemplos de Uso via API

### Vincular Exerc√≠cio a Equipamento
```bash
POST /api/exercicios/EXC001/equipamentos/EQ001
Content-Type: application/json
Authorization: Bearer {token}

{
  "descricaoUso": "Usar com aten√ß√£o √†s m√£os"
}
```

**Resposta:**
```json
{
  "statusCode": 201,
  "success": true,
  "message": "Exerc√≠cio vinculado ao equipamento com sucesso",
  "data": {
    "id": "VINC001",
    "exercicioId": "EXC001",
    "equipamentoId": "EQ001",
    "descricaoUso": "Usar com aten√ß√£o √†s m√£os",
    "disponivel": true,
    "createdAt": "2025-01-15T10:30:00Z"
  }
}
```

---

### Listar Equipamentos de um Exerc√≠cio
```bash
GET /api/exercicios/EXC001/equipamentos
Authorization: Bearer {token}
```

**Resposta:**
```json
{
  "statusCode": 200,
  "success": true,
  "message": "Equipamentos do exerc√≠cio listados com sucesso",
  "data": [
    {
      "id": "VINC001",
      "exercicioId": "EXC001",
      "equipamentoId": "EQ001",
      "descricaoUso": "Usar com aten√ß√£o √†s m√£os",
      "disponivel": true,
      "equipamento": {
        "id": "EQ001",
        "codigo": "EQ00001",
        "nome": "Haltere 10kg"
      }
    },
    {
      "id": "VINC002",
      "exercicioId": "EXC001",
      "equipamentoId": "EQ002",
      "descricaoUso": null,
      "disponivel": true,
      "equipamento": {
        "id": "EQ002",
        "codigo": "EQ00002",
        "nome": "Barra Reta"
      }
    }
  ]
}
```

---

### Obter Exerc√≠cio Completo
```bash
GET /api/exercicios/EXC001/completo
Authorization: Bearer {token}
```

**Resposta:**
```json
{
  "statusCode": 200,
  "success": true,
  "data": {
    "exercicio": {
      "id": "EXC001",
      "nome": "Rosca Direta",
      "descricao": "Exerc√≠cio para b√≠ceps",
      "musculos": ["B√≠ceps", "Braquial"],
      "imagemUrl": "https://...",
      "createdAt": "2025-01-15T08:00:00Z"
    },
    "equipamentos": [
      {
        "id": "EQ001",
        "codigo": "EQ00001",
        "nome": "Haltere 10kg",
        "descricaoUso": "Usar com aten√ß√£o √†s m√£os",
        "disponivel": true,
        "vinculoId": "VINC001"
      },
      {
        "id": "EQ002",
        "codigo": "EQ00002",
        "nome": "Barra Reta",
        "descricaoUso": null,
        "disponivel": true,
        "vinculoId": "VINC002"
      }
    ]
  }
}
```

---

### Listar Exerc√≠cios de um Equipamento
```bash
GET /api/equipamentos/EQ001/exercicios
Authorization: Bearer {token}
```

---

### Desvincular
```bash
DELETE /api/exercicios/EXC001/equipamentos/EQ001
Authorization: Bearer {token}
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Atualizar schema Prisma
- [ ] Executar migra√ß√£o
- [ ] Criar Repository
- [ ] Criar Service
- [ ] Criar Controller
- [ ] Criar Rotas
- [ ] Registrar rotas no index
- [ ] Testar endpoints com Postman/Insomnia
- [ ] Adicionar valida√ß√µes de permiss√µes
- [ ] Atualizar documenta√ß√£o da API

---

## üîê Implementar Permiss√µes (Opcional)

Adicionar ao `src/config/permissoesPadrao.js`:

```javascript
// Em TEMPLATES_PERFIS > ADMIN > modulos
exercicioEquipamentos: {
  acessar: true,
  vincular: true,
  desvincular: true,
  editar: true
}
```

Aplicar middleware nas rotas:
```javascript
router.post(
  '/:exercicioId/equipamentos/:equipamentoId',
  verificarAutenticacao,
  setEmpresaContext,
  verificarPermissaoModulo('exercicioEquipamentos', 'vincular'),
  exercicioEquipamentoController.vincular
);
```

---

## üßπ Melhorias Futuras

1. **Bulk Operations**: Vincular m√∫ltiplos equipamentos de uma vez
2. **Soft Delete**: Ao inv√©s de deletar, marcar como desativado
3. **Hist√≥rico**: Manter log de quando foi vinculado/desvinculado
4. **Cache**: Redis para queries frequentes
5. **Query Otimizada**: Incluir equipamentos ao buscar exerc√≠cio automaticamente